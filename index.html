<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>CRE Tenant Tracker</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            height: 100%;
            -webkit-text-size-adjust: 100%;
        }

        :root {
            --primary: #1e40af;
            --primary-dark: #1e3a8a;
            --primary-light: #3b82f6;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            /* Safe area for notched iPhones */
            --safe-top: env(safe-area-inset-top, 0);
            --safe-bottom: env(safe-area-inset-bottom, 0);
            --safe-left: env(safe-area-inset-left, 0);
            --safe-right: env(safe-area-inset-right, 0);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--gray-100);
            color: var(--gray-800);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding-left: var(--safe-left);
            padding-right: var(--safe-right);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem;
            padding-top: max(1rem, var(--safe-top));
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.25rem;
            font-weight: 700;
        }

        .logo svg {
            width: 32px;
            height: 32px;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            font-size: 0.875rem;
        }

        .user-info.admin::before {
            content: 'üëë';
        }

        .user-info.editor::before {
            content: '‚úèÔ∏è';
        }

        .user-info.viewer::before {
            content: 'üëÅÔ∏è';
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-primary {
            background: white;
            color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--gray-100);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.25);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-ghost {
            background: transparent;
            color: var(--gray-600);
            padding: 0.5rem;
        }

        .btn-ghost:hover {
            background: var(--gray-200);
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8125rem;
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            background: white;
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 0.8125rem;
            color: var(--gray-500);
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        /* Toolbar */
        .toolbar {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 0.625rem 1rem 0.625rem 2.5rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.875rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-box svg {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
            width: 18px;
            height: 18px;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 0.625rem 2rem 0.625rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.875rem;
            background: white;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-light);
        }

        /* Table */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th {
            background: var(--gray-50);
            padding: 0.875rem 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-200);
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: var(--gray-100);
        }

        th .sort-icon {
            margin-left: 0.25rem;
            opacity: 0.3;
        }

        th.sorted .sort-icon {
            opacity: 1;
            color: var(--primary);
        }

        td {
            padding: 0.875rem 1rem;
            border-bottom: 1px solid var(--gray-100);
            vertical-align: top;
        }

        tr:hover {
            background: var(--gray-50);
        }

        .tenant-name {
            font-weight: 600;
            color: var(--gray-900);
        }

        .broker-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: var(--primary-light);
            color: white;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .area-tag {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--gray-100);
            color: var(--gray-700);
            border-radius: 4px;
            font-size: 0.75rem;
            margin: 0.125rem;
        }

        .sqft {
            font-weight: 500;
            white-space: nowrap;
        }

        .notes-cell {
            max-width: 300px;
        }

        .notes-preview {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            color: var(--gray-600);
            font-size: 0.8125rem;
            line-height: 1.4;
        }

        .timestamp {
            font-size: 0.75rem;
            color: var(--gray-500);
            white-space: nowrap;
        }

        .actions-cell {
            white-space: nowrap;
        }

        .action-buttons {
            display: flex;
            gap: 0.25rem;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-500);
        }

        .empty-state svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.125rem;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            padding-left: max(1rem, var(--safe-left));
            padding-right: max(1rem, var(--safe-right));
            padding-bottom: max(1rem, var(--safe-bottom));
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            -webkit-overflow-scrolling: touch;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            max-height: calc(100dvh - 2rem);
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.2s;
            -webkit-overflow-scrolling: touch;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .modal-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            color: var(--gray-500);
            border-radius: 8px;
        }

        .modal-close:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
            background: var(--gray-50);
        }

        /* Form */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-size: 0.9375rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea.form-input {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-hint {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        /* Share Modal */
        .share-link-box {
            display: flex;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .share-link-input {
            flex: 1;
            padding: 0.75rem;
            background: var(--gray-100);
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.8125rem;
        }

        .permission-select {
            margin-bottom: 1rem;
        }

        .permission-option {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }

        .permission-option:hover {
            border-color: var(--gray-300);
            background: var(--gray-50);
        }

        .permission-option.selected {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.05);
        }

        .permission-option input {
            margin-top: 0.25rem;
        }

        .permission-info h4 {
            font-size: 0.9375rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .permission-info p {
            font-size: 0.8125rem;
            color: var(--gray-500);
        }

        /* Activity Log */
        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            gap: 0.75rem;
            padding: 0.875rem 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .activity-icon.add {
            background: #dcfce7;
            color: var(--success);
        }

        .activity-icon.edit {
            background: #fef3c7;
            color: var(--warning);
        }

        .activity-icon.delete {
            background: #fee2e2;
            color: var(--danger);
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        .activity-text strong {
            font-weight: 600;
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: max(1.5rem, var(--safe-bottom));
            right: max(1.5rem, var(--safe-right));
            z-index: 1100;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast {
            background: var(--gray-800);
            color: white;
            padding: 0.875rem 1.25rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            background: var(--success);
        }

        .toast.error {
            background: var(--danger);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: var(--safe-top) var(--safe-right) var(--safe-bottom) var(--safe-left);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 1rem;
            color: var(--gray-600);
        }

        /* Auth Screen */
        .auth-screen {
            min-height: 100vh;
            min-height: -webkit-fill-available;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            padding-top: max(2rem, var(--safe-top));
            padding-bottom: max(2rem, var(--safe-bottom));
            padding-left: max(2rem, var(--safe-left));
            padding-right: max(2rem, var(--safe-right));
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .auth-card {
            background: white;
            border-radius: 16px;
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-logo svg {
            width: 48px;
            height: 48px;
            color: var(--primary);
        }

        .auth-logo h1 {
            font-size: 1.5rem;
            color: var(--gray-900);
            margin-top: 0.75rem;
        }

        .auth-logo p {
            color: var(--gray-500);
            margin-top: 0.25rem;
            font-size: 0.9375rem;
        }

        .invite-info {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .invite-info p {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .invite-info strong {
            color: var(--gray-900);
        }

        /* Responsive - tablet and mobile */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }

            .header-actions {
                flex-wrap: wrap;
                justify-content: center;
            }

            .toolbar {
                flex-direction: column;
            }

            .search-box {
                width: 100%;
            }

            .filter-group {
                width: 100%;
                justify-content: stretch;
            }

            .filter-select {
                flex: 1;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .container {
                padding-left: max(1rem, var(--safe-left));
                padding-right: max(1rem, var(--safe-right));
            }

            .table-container {
                margin-left: calc(-1 * max(1rem, var(--safe-left)));
                margin-right: calc(-1 * max(1rem, var(--safe-right)));
                border-radius: 0;
            }

            th, td {
                padding: 0.75rem 0.5rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            /* 16px inputs prevent iOS zoom on focus */
            .form-input,
            .search-box input,
            .filter-select,
            textarea.form-input {
                font-size: 16px !important;
            }

            /* Touch targets at least 44px (Apple HIG) */
            .btn,
            .filter-select,
            .autocomplete-item,
            .permission-option {
                min-height: 44px;
            }

            .btn-sm {
                min-height: 44px;
                padding: 0.5rem 0.75rem;
            }

            .modal {
                max-height: calc(100dvh - var(--safe-top) - var(--safe-bottom) - 1rem);
                border-radius: 12px;
            }

            .modal-header,
            .modal-body,
            .modal-footer {
                padding-left: max(1rem, var(--safe-left));
                padding-right: max(1rem, var(--safe-right));
            }
        }

        /* Small phones (iPhone portrait, etc.) */
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 1rem;
                padding-left: max(1rem, var(--safe-left));
                padding-right: max(1rem, var(--safe-right));
            }

            .header {
                padding: 0.75rem;
                padding-top: max(0.75rem, var(--safe-top));
            }

            .stat-card {
                padding: 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            th, td {
                padding: 0.625rem 0.5rem;
                font-size: 0.8125rem;
            }

            .modal-header h2 {
                font-size: 1.125rem;
            }

            .modal-close {
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* Record Permissions Badge */
        .record-permission {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.125rem 0.375rem;
            background: var(--gray-100);
            border-radius: 4px;
            font-size: 0.6875rem;
            color: var(--gray-600);
        }

        .record-permission.shared {
            background: #dbeafe;
            color: var(--primary);
        }

        /* Shared Users Indicator */
        .shared-users {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.25rem;
        }

        .shared-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-light);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.625rem;
            font-weight: 600;
            border: 2px solid white;
            margin-left: -8px;
        }

        .shared-avatar:first-child {
            margin-left: 0;
        }

        .shared-count {
            font-size: 0.6875rem;
            color: var(--gray-500);
            margin-left: 0.25rem;
        }

        /* Note History Styles */
        .note-history {
            margin-top: 1rem;
            border-top: 1px solid var(--gray-200);
            padding-top: 1rem;
        }

        .note-history-title {
            font-size: 0.8125rem;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .note-history-title svg {
            width: 14px;
            height: 14px;
            color: var(--gray-500);
        }

        .note-entry {
            background: var(--gray-50);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--primary-light);
        }

        .note-entry:last-child {
            margin-bottom: 0;
        }

        .note-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .note-entry-author {
            font-weight: 500;
            color: var(--gray-700);
        }

        .note-entry-content {
            font-size: 0.8125rem;
            color: var(--gray-700);
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .note-entry.current {
            border-left-color: var(--success);
            background: #f0fdf4;
        }

        /* Autocomplete Styles */
        .autocomplete-wrapper {
            position: relative;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--gray-300);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }

        .autocomplete-list.active {
            display: block;
        }

        .autocomplete-item {
            padding: 0.625rem 0.875rem;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .autocomplete-item:hover,
        .autocomplete-item.highlighted {
            background: var(--gray-100);
        }

        .autocomplete-item svg {
            width: 14px;
            height: 14px;
            color: var(--gray-400);
        }

        .autocomplete-hint {
            padding: 0.5rem 0.875rem;
            font-size: 0.75rem;
            color: var(--gray-500);
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
        }

        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.375rem;
            padding: 0.375rem;
            border: 1px solid var(--gray-300);
            border-radius: 8px;
            min-height: 42px;
            cursor: text;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .tag-input-container:focus-within {
            border-color: var(--primary-light);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .tag-input-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: var(--primary-light);
            color: white;
            border-radius: 4px;
            font-size: 0.8125rem;
        }

        .tag-input-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            opacity: 0.7;
        }

        .tag-input-tag button:hover {
            opacity: 1;
        }

        .tag-input-field {
            flex: 1;
            min-width: 120px;
            border: none;
            outline: none;
            padding: 0.25rem;
            font-size: 0.9375rem;
        }

        /* Map Styles */
        .map-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            display: none;
        }

        .map-container.active {
            display: block;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .map-header h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray-800);
        }

        .map-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .map-toggle {
            display: flex;
            background: var(--gray-100);
            border-radius: 6px;
            padding: 2px;
        }

        .map-toggle button {
            padding: 0.375rem 0.75rem;
            border: none;
            background: transparent;
            font-size: 0.8125rem;
            color: var(--gray-600);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .map-toggle button.active {
            background: white;
            color: var(--gray-900);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        #map {
            height: 500px;
            width: 100%;
        }

        .map-legend {
            padding: 1rem;
            border-top: 1px solid var(--gray-200);
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            font-size: 0.8125rem;
            color: var(--gray-600);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .legend-dot.marker {
            background: #3b82f6;
        }

        .legend-gradient {
            width: 80px;
            height: 12px;
            border-radius: 6px;
            background: linear-gradient(to right, rgba(0,0,255,0.2), rgba(0,255,0,0.5), rgba(255,255,0,0.7), rgba(255,0,0,0.9));
        }

        .view-toggle-group {
            display: flex;
            gap: 0.5rem;
        }

        .btn-view {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .btn-view:hover {
            background: rgba(255,255,255,0.25);
        }

        .btn-view.active {
            background: white;
            color: var(--primary);
        }

        /* Leaflet popup styling */
        .leaflet-popup-content {
            margin: 0.75rem 1rem;
        }

        .popup-title {
            font-weight: 600;
            font-size: 0.9375rem;
            margin-bottom: 0.5rem;
            color: var(--gray-900);
        }

        .popup-detail {
            font-size: 0.8125rem;
            color: var(--gray-600);
            margin-bottom: 0.25rem;
        }

        .popup-sqft {
            font-weight: 600;
            color: var(--primary);
        }

        /* Geocoding status */
        .geocode-status {
            font-size: 0.75rem;
            color: var(--gray-500);
            padding: 0.5rem 1rem;
            background: var(--gray-50);
            border-top: 1px solid var(--gray-200);
        }

        .geocode-status.loading {
            color: var(--warning);
        }

        .geocode-status.error {
            color: var(--danger);
        }

        /* Print styles */
        @media print {
            .header, .toolbar, .stats-grid, .modal-overlay, .toast-container, .map-controls, .btn {
                display: none !important;
            }

            .map-container {
                box-shadow: none;
                border: 1px solid #ccc;
            }

            #map {
                height: 700px !important;
            }

            .container {
                padding: 0;
                max-width: 100%;
            }

            body {
                background: white;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-overlay">
        <div class="spinner"></div>
        <p class="loading-text">Connecting...</p>
    </div>

    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen" style="display: none;">
        <div class="auth-card">
            <div class="auth-logo">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 21h18M3 7v14m18-14v14M6 7h12M6 11h12M6 15h12"/>
                    <path d="M9 21v-4h6v4"/>
                </svg>
                <h1>CRE Tenant Tracker</h1>
                <p>Commercial Real Estate Database</p>
            </div>

            <div id="inviteInfo" class="invite-info" style="display: none;">
                <p>You've been invited by <strong id="inviterName"></strong></p>
            </div>

            <div class="form-group">
                <label class="form-label">Your Name</label>
                <input type="text" id="userName" class="form-input" placeholder="Enter your name">
            </div>

            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="userEmail" class="form-input" placeholder="Enter your email">
            </div>

            <button id="joinBtn" class="btn btn-primary" style="width: 100%; justify-content: center; padding: 0.875rem; font-size: 1rem;">
                Continue
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <header class="header">
            <div class="header-content">
                <div class="logo">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 21h18M3 7v14m18-14v14M6 7h12M6 11h12M6 15h12"/>
                        <path d="M9 21v-4h6v4"/>
                    </svg>
                    <span>CRE Tenant Tracker</span>
                </div>

                <div class="header-actions">
                    <div id="userBadge" class="user-info admin">
                        <span id="currentUserName">Admin</span>
                    </div>
                    <button id="shareBtn" class="btn btn-secondary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
                            <path d="M8.59 13.51l6.83 3.98M15.41 6.51l-6.82 3.98"/>
                        </svg>
                        Share
                    </button>
                    <button id="activityBtn" class="btn btn-secondary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                        </svg>
                        Activity
                    </button>
                    <div class="view-toggle-group">
                        <button id="tableViewBtn" class="btn btn-view active">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 3h18v18H3zM3 9h18M3 15h18M9 3v18"/>
                            </svg>
                            Table
                        </button>
                        <button id="mapViewBtn" class="btn btn-view">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            Map
                        </button>
                    </div>
                    <button id="exportBtn" class="btn btn-secondary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                        </svg>
                        Export
                    </button>
                    <button id="addTenantBtn" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        Add Tenant
                    </button>
                </div>
            </div>
        </header>

        <main class="container">
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Tenants</div>
                    <div id="statTotal" class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Sq Ft Demand</div>
                    <div id="statSqft" class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Unique Brokers</div>
                    <div id="statBrokers" class="stat-value">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Updated This Week</div>
                    <div id="statRecent" class="stat-value">0</div>
                </div>
            </div>

            <!-- Toolbar -->
            <div class="toolbar">
                <div class="search-box">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search tenants, brokers, areas...">
                </div>
                <div class="filter-group">
                    <select id="filterBroker" class="filter-select">
                        <option value="">All Brokers</option>
                    </select>
                    <select id="filterArea" class="filter-select">
                        <option value="">All Areas</option>
                    </select>
                    <select id="filterSqft" class="filter-select">
                        <option value="">All Sizes</option>
                        <option value="0-5000">Under 5,000 SF</option>
                        <option value="5000-10000">5,000 - 10,000 SF</option>
                        <option value="10000-25000">10,000 - 25,000 SF</option>
                        <option value="25000-50000">25,000 - 50,000 SF</option>
                        <option value="50000+">50,000+ SF</option>
                    </select>
                </div>
            </div>

            <!-- Table -->
            <div class="table-container">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th data-sort="name">Tenant Name <span class="sort-icon">‚Üï</span></th>
                                <th data-sort="address">Address <span class="sort-icon">‚Üï</span></th>
                                <th data-sort="broker">Broker <span class="sort-icon">‚Üï</span></th>
                                <th data-sort="area">Search Area <span class="sort-icon">‚Üï</span></th>
                                <th data-sort="sqft">Sq Ft <span class="sort-icon">‚Üï</span></th>
                                <th>Notes</th>
                                <th data-sort="updated">Last Updated <span class="sort-icon">‚Üï</span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tenantTableBody">
                        </tbody>
                    </table>
                </div>

                <div id="emptyState" class="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M3 21h18M3 7v14m18-14v14M6 7h12M6 11h12M6 15h12"/>
                        <path d="M9 21v-4h6v4"/>
                    </svg>
                    <h3>No tenants yet</h3>
                    <p>Add your first tenant to get started</p>
                </div>
            </div>

            <!-- Map View -->
            <div id="mapContainer" class="map-container">
                <div class="map-header">
                    <h3>Tenant Locations & Demand Density</h3>
                    <div class="map-controls">
                        <div class="map-toggle">
                            <button id="toggleMarkers" class="active">Markers</button>
                            <button id="toggleHeatmap">Heat Map</button>
                            <button id="toggleBoth">Both</button>
                        </div>
                        <button id="printMapBtn" class="btn btn-sm btn-secondary">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/>
                                <rect x="6" y="14" width="12" height="8"/>
                            </svg>
                            Print
                        </button>
                    </div>
                </div>
                <div id="map"></div>
                <div id="geocodeStatus" class="geocode-status"></div>
                <div class="map-legend">
                    <div class="legend-item">
                        <div class="legend-dot marker"></div>
                        <span>Tenant Location</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-gradient"></div>
                        <span>SF Demand (Low ‚Üí High)</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Tenant Modal -->
    <div id="tenantModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Tenant</h2>
                <button class="modal-close" onclick="closeModal('tenantModal')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="tenantId">

                <div class="form-group">
                    <label class="form-label">Tenant Name *</label>
                    <input type="text" id="tenantName" class="form-input" placeholder="Company or tenant name">
                </div>

                <div class="form-group">
                    <label class="form-label">Current Address</label>
                    <input type="text" id="tenantAddress" class="form-input" placeholder="Current tenant address (optional)">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Broker Name *</label>
                        <input type="text" id="brokerName" class="form-input" placeholder="Broker's name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Square Footage *</label>
                        <input type="text" id="sqftRange" class="form-input" placeholder="e.g., 5,000 - 10,000">
                        <p class="form-hint">Enter a single number or range</p>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Geographic Search Area *</label>
                    <div class="autocomplete-wrapper">
                        <div id="areaTagContainer" class="tag-input-container">
                            <input type="text" id="searchAreaInput" class="tag-input-field" placeholder="Type to search or add areas...">
                        </div>
                        <div id="areaAutocomplete" class="autocomplete-list">
                            <div class="autocomplete-hint">Select from previously used areas or type a new one</div>
                        </div>
                    </div>
                    <input type="hidden" id="searchArea">
                    <p class="form-hint">Press Enter or comma to add an area. Click √ó to remove.</p>
                </div>

                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea id="tenantNotes" class="form-input" placeholder="Additional details, requirements, timeline, etc."></textarea>
                    <div id="noteHistoryPreview" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('tenantModal')">Cancel</button>
                <button id="saveTenantBtn" class="btn btn-success">Save Tenant</button>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="shareModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Share Access</h2>
                <button class="modal-close" onclick="closeModal('shareModal')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--gray-600);">Create an invite link to share access with others.</p>

                <div class="permission-select">
                    <label class="permission-option selected" data-permission="admin">
                        <input type="radio" name="permission" value="admin" checked>
                        <div class="permission-info">
                            <h4>üëë Admin</h4>
                            <p>Full access - can add, edit, delete all records and manage sharing</p>
                        </div>
                    </label>
                    <label class="permission-option" data-permission="editor">
                        <input type="radio" name="permission" value="editor">
                        <div class="permission-info">
                            <h4>‚úèÔ∏è Editor</h4>
                            <p>Can add new records and edit/delete their own records</p>
                        </div>
                    </label>
                    <label class="permission-option" data-permission="viewer">
                        <input type="radio" name="permission" value="viewer">
                        <div class="permission-info">
                            <h4>üëÅÔ∏è Viewer</h4>
                            <p>Can only view records (read-only access)</p>
                        </div>
                    </label>
                </div>

                <div id="recordAccessSection" style="margin-top: 1.5rem; border-top: 1px solid var(--gray-200); padding-top: 1.5rem;">
                    <label class="form-label">Record Access (Optional)</label>
                    <p style="font-size: 0.8125rem; color: var(--gray-500); margin-bottom: 0.75rem;">
                        Leave empty for access to all records, or select specific records to share.
                    </p>
                    <select id="recordAccess" class="filter-select" multiple style="width: 100%; height: 120px;">
                    </select>
                </div>

                <div class="share-link-box">
                    <input type="text" id="shareLink" class="share-link-input" readonly>
                    <button id="copyLinkBtn" class="btn btn-primary btn-sm">Copy</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('shareModal')">Close</button>
                <button id="generateLinkBtn" class="btn btn-success">Generate New Link</button>
            </div>
        </div>
    </div>

    <!-- Activity Modal -->
    <div id="activityModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Activity Log</h2>
                <button class="modal-close" onclick="closeModal('activityModal')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div id="activityList" class="activity-list">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('activityModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- View Tenant Modal -->
    <div id="viewModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="viewTenantName">Tenant Details</h2>
                <button class="modal-close" onclick="closeModal('viewModal')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="viewModalBody">
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('viewModal')">Close</button>
                <button id="editFromViewBtn" class="btn btn-primary">Edit</button>
            </div>
        </div>
    </div>

    <!-- Record Share Modal -->
    <div id="recordShareModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Share This Record</h2>
                <button class="modal-close" onclick="closeModal('recordShareModal')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="shareRecordId">
                <p style="margin-bottom: 1rem; color: var(--gray-600);">Create a link to share access to this specific tenant record.</p>

                <div class="permission-select">
                    <label class="permission-option selected" data-permission="editor">
                        <input type="radio" name="recordPermission" value="editor" checked>
                        <div class="permission-info">
                            <h4>‚úèÔ∏è Can Edit</h4>
                            <p>Can view and update this record</p>
                        </div>
                    </label>
                    <label class="permission-option" data-permission="viewer">
                        <input type="radio" name="recordPermission" value="viewer">
                        <div class="permission-info">
                            <h4>üëÅÔ∏è View Only</h4>
                            <p>Can only view this record</p>
                        </div>
                    </label>
                </div>

                <div class="share-link-box">
                    <input type="text" id="recordShareLink" class="share-link-input" readonly>
                    <button id="copyRecordLinkBtn" class="btn btn-primary btn-sm">Copy</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('recordShareModal')">Close</button>
                <button id="generateRecordLinkBtn" class="btn btn-success">Generate Link</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet Heat Map Plugin -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <script>
        // Firebase Configuration - Connected to sh-tenant-tracker
        const firebaseConfig = {
            apiKey: "AIzaSyCI1n2t4tM0-4W5A0feeimsL8KsrJ2IttY",
            authDomain: "sh-tenant-tracker.firebaseapp.com",
            databaseURL: "https://sh-tenant-tracker-default-rtdb.firebaseio.com",
            projectId: "sh-tenant-tracker",
            storageBucket: "sh-tenant-tracker.firebasestorage.app",
            messagingSenderId: "583334725666",
            appId: "1:583334725666:web:dfe7fd50f32f0a770ee27b",
            measurementId: "G-2MQDVS20B2"
        };

        // Initialize Firebase
        let db;
        let currentUser = null;
        let tenants = [];
        let activities = [];
        let invites = {};
        let sortColumn = 'updated';
        let sortDirection = 'desc';
        let knownAreas = new Set(); // Store all known geographic areas
        let selectedAreaTags = []; // Currently selected area tags in the form
        let highlightedAutocompleteIndex = -1;

        // Demo mode (works without Firebase)
        const DEMO_MODE = firebaseConfig.apiKey === "YOUR_API_KEY";

        // Initialize App
        async function init() {
            if (!DEMO_MODE) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
            }

            // Check for invite link
            const urlParams = new URLSearchParams(window.location.search);
            const inviteId = urlParams.get('invite');
            const recordId = urlParams.get('record');

            if (inviteId) {
                await handleInvite(inviteId, recordId);
            } else {
                // Check for existing session
                const savedUser = localStorage.getItem('cre_user');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    showMainApp();
                } else {
                    showAuthScreen();
                }
            }
        }

        // Handle invite link
        async function handleInvite(inviteId, recordId) {
            document.getElementById('loadingScreen').style.display = 'none';

            if (!DEMO_MODE) {
                const inviteSnapshot = await db.ref(`invites/${inviteId}`).once('value');
                const invite = inviteSnapshot.val();

                if (invite) {
                    document.getElementById('inviteInfo').style.display = 'block';
                    document.getElementById('inviterName').textContent = invite.createdBy;

                    // Store invite info for later
                    sessionStorage.setItem('pendingInvite', JSON.stringify({
                        inviteId,
                        permission: invite.permission,
                        records: invite.records || null,
                        recordId: recordId
                    }));
                }
            } else {
                // Demo mode - simulate invite
                document.getElementById('inviteInfo').style.display = 'block';
                document.getElementById('inviterName').textContent = 'Demo User';
                sessionStorage.setItem('pendingInvite', JSON.stringify({
                    inviteId,
                    permission: 'editor',
                    records: recordId ? [recordId] : null,
                    recordId: recordId
                }));
            }

            showAuthScreen();
        }

        // Show auth screen
        function showAuthScreen() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        // Show main app
        function showMainApp() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';

            updateUserBadge();
            loadData();
        }

        // Update user badge
        function updateUserBadge() {
            const badge = document.getElementById('userBadge');
            const nameSpan = document.getElementById('currentUserName');

            badge.className = `user-info ${currentUser.permission}`;
            nameSpan.textContent = currentUser.name;

            // Show/hide buttons based on permission
            const addBtn = document.getElementById('addTenantBtn');
            const shareBtn = document.getElementById('shareBtn');

            if (currentUser.permission === 'viewer') {
                addBtn.style.display = 'none';
            }

            if (currentUser.permission !== 'admin') {
                shareBtn.style.display = 'none';
            }
        }

        // Join/Login
        document.getElementById('joinBtn').addEventListener('click', async () => {
            const name = document.getElementById('userName').value.trim();
            const email = document.getElementById('userEmail').value.trim();

            if (!name || !email) {
                showToast('Please enter your name and email', 'error');
                return;
            }

            // Check for pending invite
            const pendingInvite = sessionStorage.getItem('pendingInvite');
            let permission = 'admin';
            let accessRecords = null;

            if (pendingInvite) {
                const invite = JSON.parse(pendingInvite);
                permission = invite.permission;
                accessRecords = invite.records;
                sessionStorage.removeItem('pendingInvite');

                // Clear URL params
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            currentUser = {
                id: generateId(),
                name,
                email,
                permission,
                accessRecords,
                createdAt: new Date().toISOString()
            };

            localStorage.setItem('cre_user', JSON.stringify(currentUser));

            if (!DEMO_MODE) {
                await db.ref(`users/${currentUser.id}`).set(currentUser);
            }

            showMainApp();
        });

        // Load data
        async function loadData() {
            if (DEMO_MODE) {
                // Load demo data
                tenants = getDemoData();
                activities = getDemoActivities();
            } else {
                // Load from Firebase
                db.ref('tenants').on('value', (snapshot) => {
                    const data = snapshot.val() || {};
                    tenants = Object.values(data);
                    renderTable();
                    updateStats();
                    updateFilters();
                });

                db.ref('activities').orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
                    const data = snapshot.val() || {};
                    activities = Object.values(data).sort((a, b) =>
                        new Date(b.timestamp) - new Date(a.timestamp)
                    );
                });
            }

            renderTable();
            updateStats();
            updateFilters();
        }

        // Demo data
        function getDemoData() {
            return [
                {
                    id: '1',
                    name: 'TechCorp Industries',
                    broker: 'John Smith',
                    area: 'Downtown, Financial District',
                    sqft: '15,000 - 20,000',
                    sqftMin: 15000,
                    notes: 'Budget around $45/SF. Flexible on move-in date.',
                    noteHistory: [
                        { text: 'Looking for Class A space with modern amenities.', author: 'Admin', timestamp: '2024-01-15T10:00:00Z' },
                        { text: 'Flexible on move-in date.', author: 'Admin', timestamp: '2024-01-18T14:30:00Z' },
                        { text: 'Budget around $45/SF. Flexible on move-in date.', author: 'Admin', timestamp: '2024-01-20T14:30:00Z' }
                    ],
                    createdAt: '2024-01-15T10:00:00Z',
                    updatedAt: '2024-01-20T14:30:00Z',
                    createdBy: 'Admin',
                    updatedBy: 'Admin'
                },
                {
                    id: '2',
                    name: 'Green Energy Solutions',
                    broker: 'Sarah Johnson',
                    area: 'Westside, Tech Corridor',
                    sqft: '8,000 - 12,000',
                    sqftMin: 8000,
                    notes: 'Sustainability-focused company. Requires LEED certified building. Prefers open floor plan.',
                    noteHistory: [
                        { text: 'Sustainability-focused company.', author: 'Admin', timestamp: '2024-01-18T09:00:00Z' },
                        { text: 'Sustainability-focused company. Requires LEED certified building. Prefers open floor plan.', author: 'Sarah Johnson', timestamp: '2024-01-22T11:15:00Z' }
                    ],
                    createdAt: '2024-01-18T09:00:00Z',
                    updatedAt: '2024-01-22T11:15:00Z',
                    createdBy: 'Admin',
                    updatedBy: 'Sarah Johnson'
                },
                {
                    id: '3',
                    name: 'Medical Associates Group',
                    broker: 'Mike Chen',
                    area: 'Medical District, Midtown',
                    sqft: '25,000 - 35,000',
                    sqftMin: 25000,
                    notes: 'Medical office space needed. Must have adequate parking. Considering build-to-suit options.',
                    noteHistory: [
                        { text: 'Medical office space needed.', author: 'Mike Chen', timestamp: '2024-01-10T08:00:00Z' },
                        { text: 'Medical office space needed. Must have adequate parking.', author: 'Mike Chen', timestamp: '2024-01-15T10:00:00Z' },
                        { text: 'Medical office space needed. Must have adequate parking. Considering build-to-suit options.', author: 'Admin', timestamp: '2024-01-23T16:45:00Z' }
                    ],
                    createdAt: '2024-01-10T08:00:00Z',
                    updatedAt: '2024-01-23T16:45:00Z',
                    createdBy: 'Mike Chen',
                    updatedBy: 'Admin'
                },
                {
                    id: '4',
                    name: 'StartupHub Co',
                    broker: 'John Smith',
                    area: 'Innovation District',
                    sqft: '3,000 - 5,000',
                    sqftMin: 3000,
                    notes: 'Fast-growing startup. May need expansion options within 12 months. Flexible lease terms preferred.',
                    noteHistory: [
                        { text: 'Fast-growing startup. May need expansion options within 12 months. Flexible lease terms preferred.', author: 'Admin', timestamp: '2024-01-21T13:00:00Z' }
                    ],
                    createdAt: '2024-01-21T13:00:00Z',
                    updatedAt: '2024-01-21T13:00:00Z',
                    createdBy: 'Admin',
                    updatedBy: 'Admin'
                },
                {
                    id: '5',
                    name: 'Global Logistics Inc',
                    broker: 'Sarah Johnson',
                    area: 'Airport Area, Industrial Park',
                    sqft: '50,000 - 75,000',
                    sqftMin: 50000,
                    notes: 'Warehouse/distribution center needed. High ceiling clearance required. Loading dock access essential.',
                    noteHistory: [
                        { text: 'Warehouse/distribution center needed.', author: 'Sarah Johnson', timestamp: '2024-01-19T11:00:00Z' },
                        { text: 'Warehouse/distribution center needed. High ceiling clearance required. Loading dock access essential.', author: 'Sarah Johnson', timestamp: '2024-01-24T09:30:00Z' }
                    ],
                    createdAt: '2024-01-19T11:00:00Z',
                    updatedAt: '2024-01-24T09:30:00Z',
                    createdBy: 'Sarah Johnson',
                    updatedBy: 'Sarah Johnson'
                }
            ];
        }

        function getDemoActivities() {
            return [
                { id: '1', type: 'add', tenant: 'TechCorp Industries', user: 'Admin', timestamp: '2024-01-15T10:00:00Z' },
                { id: '2', type: 'edit', tenant: 'TechCorp Industries', user: 'Admin', timestamp: '2024-01-20T14:30:00Z', changes: 'Updated notes' },
                { id: '3', type: 'add', tenant: 'Green Energy Solutions', user: 'Admin', timestamp: '2024-01-18T09:00:00Z' },
                { id: '4', type: 'edit', tenant: 'Green Energy Solutions', user: 'Sarah Johnson', timestamp: '2024-01-22T11:15:00Z', changes: 'Updated square footage' },
                { id: '5', type: 'add', tenant: 'Medical Associates Group', user: 'Mike Chen', timestamp: '2024-01-10T08:00:00Z' },
            ];
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('tenantTableBody');
            const emptyState = document.getElementById('emptyState');

            // Filter tenants based on user access
            let visibleTenants = tenants;
            if (currentUser.accessRecords && currentUser.accessRecords.length > 0) {
                visibleTenants = tenants.filter(t => currentUser.accessRecords.includes(t.id));
            }

            // Apply search filter
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                visibleTenants = visibleTenants.filter(t =>
                    t.name.toLowerCase().includes(searchTerm) ||
                    t.broker.toLowerCase().includes(searchTerm) ||
                    t.area.toLowerCase().includes(searchTerm) ||
                    (t.notes && t.notes.toLowerCase().includes(searchTerm))
                );
            }

            // Apply broker filter
            const brokerFilter = document.getElementById('filterBroker').value;
            if (brokerFilter) {
                visibleTenants = visibleTenants.filter(t => t.broker === brokerFilter);
            }

            // Apply area filter
            const areaFilter = document.getElementById('filterArea').value;
            if (areaFilter) {
                visibleTenants = visibleTenants.filter(t => t.area.includes(areaFilter));
            }

            // Apply sqft filter
            const sqftFilter = document.getElementById('filterSqft').value;
            if (sqftFilter) {
                visibleTenants = visibleTenants.filter(t => {
                    const min = t.sqftMin || parseSqft(t.sqft);
                    if (sqftFilter === '50000+') return min >= 50000;
                    const [filterMin, filterMax] = sqftFilter.split('-').map(Number);
                    return min >= filterMin && min < filterMax;
                });
            }

            // Sort
            visibleTenants.sort((a, b) => {
                let aVal, bVal;
                switch (sortColumn) {
                    case 'name': aVal = a.name; bVal = b.name; break;
                    case 'address': aVal = a.address || ''; bVal = b.address || ''; break;
                    case 'broker': aVal = a.broker; bVal = b.broker; break;
                    case 'area': aVal = a.area; bVal = b.area; break;
                    case 'sqft': aVal = a.sqftMin || 0; bVal = b.sqftMin || 0; break;
                    case 'updated': aVal = new Date(a.updatedAt); bVal = new Date(b.updatedAt); break;
                    default: aVal = a.name; bVal = b.name;
                }

                if (typeof aVal === 'string') {
                    return sortDirection === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                return sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
            });

            if (visibleTenants.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            tbody.innerHTML = visibleTenants.map(tenant => {
                const canEdit = canEditRecord(tenant);
                const canDelete = canDeleteRecord(tenant);
                const areas = tenant.area.split(',').map(a =>
                    `<span class="area-tag">${a.trim()}</span>`
                ).join('');

                return `
                    <tr>
                        <td>
                            <div class="tenant-name">${escapeHtml(tenant.name)}</div>
                        </td>
                        <td style="font-size: 0.8125rem; color: var(--gray-600);">${escapeHtml(tenant.address || '-')}</td>
                        <td><span class="broker-badge">${escapeHtml(tenant.broker)}</span></td>
                        <td>${areas}</td>
                        <td class="sqft">${escapeHtml(tenant.sqft)} SF</td>
                        <td class="notes-cell">
                            <div class="notes-preview">${escapeHtml(tenant.notes || 'No notes')}</div>
                        </td>
                        <td>
                            <div class="timestamp">${formatDate(tenant.updatedAt)}</div>
                            <div class="timestamp" style="color: var(--gray-400)">by ${escapeHtml(tenant.updatedBy || 'Unknown')}</div>
                        </td>
                        <td class="actions-cell">
                            <div class="action-buttons">
                                <button class="btn btn-ghost btn-sm" onclick="viewTenant('${tenant.id}')" title="View">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                                ${canEdit ? `
                                <button class="btn btn-ghost btn-sm" onclick="editTenant('${tenant.id}')" title="Edit">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                </button>
                                ` : ''}
                                ${currentUser.permission === 'admin' ? `
                                <button class="btn btn-ghost btn-sm" onclick="shareRecord('${tenant.id}')" title="Share">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/>
                                        <path d="M8.59 13.51l6.83 3.98M15.41 6.51l-6.82 3.98"/>
                                    </svg>
                                </button>
                                ` : ''}
                                ${canDelete ? `
                                <button class="btn btn-ghost btn-sm" onclick="deleteTenant('${tenant.id}')" title="Delete" style="color: var(--danger)">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                    </svg>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Permission checks
        function canEditRecord(tenant) {
            if (currentUser.permission === 'admin') return true;
            if (currentUser.permission === 'viewer') return false;
            // Editors can edit their own records or records shared with edit access
            return tenant.createdBy === currentUser.name ||
                   (currentUser.accessRecords && currentUser.accessRecords.includes(tenant.id));
        }

        function canDeleteRecord(tenant) {
            if (currentUser.permission === 'admin') return true;
            if (currentUser.permission === 'viewer') return false;
            // Editors can only delete their own records
            return tenant.createdBy === currentUser.name;
        }

        // Update stats
        function updateStats() {
            let visibleTenants = tenants;
            if (currentUser.accessRecords && currentUser.accessRecords.length > 0) {
                visibleTenants = tenants.filter(t => currentUser.accessRecords.includes(t.id));
            }

            document.getElementById('statTotal').textContent = visibleTenants.length;

            const totalSqft = visibleTenants.reduce((sum, t) => sum + (t.sqftMin || parseSqft(t.sqft)), 0);
            document.getElementById('statSqft').textContent = formatNumber(totalSqft);

            const brokers = new Set(visibleTenants.map(t => t.broker));
            document.getElementById('statBrokers').textContent = brokers.size;

            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const recentCount = visibleTenants.filter(t => new Date(t.updatedAt) > weekAgo).length;
            document.getElementById('statRecent').textContent = recentCount;
        }

        // Update filters
        function updateFilters() {
            const brokers = [...new Set(tenants.map(t => t.broker))].sort();
            const brokerSelect = document.getElementById('filterBroker');
            brokerSelect.innerHTML = '<option value="">All Brokers</option>' +
                brokers.map(b => `<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`).join('');

            const areas = [...new Set(tenants.flatMap(t => t.area.split(',').map(a => a.trim())))].sort();
            const areaSelect = document.getElementById('filterArea');
            areaSelect.innerHTML = '<option value="">All Areas</option>' +
                areas.map(a => `<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join('');

            // Update known areas for autocomplete
            areas.forEach(a => knownAreas.add(a));

            // Update record access list for sharing
            const recordSelect = document.getElementById('recordAccess');
            recordSelect.innerHTML = tenants.map(t =>
                `<option value="${t.id}">${escapeHtml(t.name)}</option>`
            ).join('');
        }

        // Search and filter handlers
        document.getElementById('searchInput').addEventListener('input', debounce(renderTable, 300));
        document.getElementById('filterBroker').addEventListener('change', renderTable);
        document.getElementById('filterArea').addEventListener('change', renderTable);
        document.getElementById('filterSqft').addEventListener('change', renderTable);

        // Sort handler
        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.sort;
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }

                document.querySelectorAll('th').forEach(h => h.classList.remove('sorted'));
                th.classList.add('sorted');
                th.querySelector('.sort-icon').textContent = sortDirection === 'asc' ? '‚Üë' : '‚Üì';

                renderTable();
            });
        });

        // Modal handlers
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // Add tenant button
        document.getElementById('addTenantBtn').addEventListener('click', () => {
            document.getElementById('modalTitle').textContent = 'Add New Tenant';
            document.getElementById('tenantId').value = '';
            document.getElementById('tenantName').value = '';
            document.getElementById('tenantAddress').value = '';
            document.getElementById('brokerName').value = '';
            document.getElementById('sqftRange').value = '';
            document.getElementById('searchArea').value = '';
            document.getElementById('tenantNotes').value = '';
            clearAreaTags();
            hideNoteHistory();
            openModal('tenantModal');
        });

        // Save tenant
        document.getElementById('saveTenantBtn').addEventListener('click', async () => {
            const id = document.getElementById('tenantId').value;
            const name = document.getElementById('tenantName').value.trim();
            const address = document.getElementById('tenantAddress').value.trim();
            const broker = document.getElementById('brokerName').value.trim();
            const sqft = document.getElementById('sqftRange').value.trim();
            const area = selectedAreaTags.join(', ');
            const notes = document.getElementById('tenantNotes').value.trim();

            if (!name || !broker || !sqft || selectedAreaTags.length === 0) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            const now = new Date().toISOString();
            const tenant = {
                id: id || generateId(),
                name,
                address,
                broker,
                sqft,
                sqftMin: parseSqft(sqft),
                area,
                notes,
                updatedAt: now,
                updatedBy: currentUser.name
            };

            if (id) {
                // Update existing
                const existing = tenants.find(t => t.id === id);
                tenant.createdAt = existing.createdAt;
                tenant.createdBy = existing.createdBy;

                // Handle note history
                tenant.noteHistory = existing.noteHistory || [];
                if (notes !== existing.notes && notes) {
                    // Add new note entry if notes changed
                    tenant.noteHistory.push({
                        text: notes,
                        author: currentUser.name,
                        timestamp: now
                    });
                }

                if (DEMO_MODE) {
                    const index = tenants.findIndex(t => t.id === id);
                    tenants[index] = tenant;
                } else {
                    await db.ref(`tenants/${id}`).update(tenant);
                }

                logActivity('edit', tenant.name, notes !== existing.notes ? 'Updated notes' : 'Updated record');
                showToast('Tenant updated successfully', 'success');
            } else {
                // Add new
                tenant.createdAt = now;
                tenant.createdBy = currentUser.name;

                // Initialize note history for new tenant
                if (notes) {
                    tenant.noteHistory = [{
                        text: notes,
                        author: currentUser.name,
                        timestamp: now
                    }];
                } else {
                    tenant.noteHistory = [];
                }

                if (DEMO_MODE) {
                    tenants.push(tenant);
                } else {
                    await db.ref(`tenants/${tenant.id}`).set(tenant);
                }

                logActivity('add', tenant.name);
                showToast('Tenant added successfully', 'success');
            }

            // Add new areas to known areas
            selectedAreaTags.forEach(a => knownAreas.add(a));

            closeModal('tenantModal');
            renderTable();
            updateStats();
            updateFilters();
        });

        // View tenant
        function viewTenant(id) {
            const tenant = tenants.find(t => t.id === id);
            if (!tenant) return;

            // Build note history HTML
            let noteHistoryHtml = '';
            if (tenant.noteHistory && tenant.noteHistory.length > 0) {
                const sortedHistory = [...tenant.noteHistory].sort((a, b) =>
                    new Date(b.timestamp) - new Date(a.timestamp)
                );
                noteHistoryHtml = `
                    <div class="note-history">
                        <div class="note-history-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                            </svg>
                            Note History (${sortedHistory.length} ${sortedHistory.length === 1 ? 'entry' : 'entries'})
                        </div>
                        ${sortedHistory.map((entry, idx) => `
                            <div class="note-entry ${idx === 0 ? 'current' : ''}">
                                <div class="note-entry-header">
                                    <span class="note-entry-author">${escapeHtml(entry.author)}</span>
                                    <span>${formatDateTime(entry.timestamp)}</span>
                                </div>
                                <div class="note-entry-content">${escapeHtml(entry.text)}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            document.getElementById('viewTenantName').textContent = tenant.name;
            document.getElementById('viewModalBody').innerHTML = `
                <div style="display: grid; gap: 1rem;">
                    <div>
                        <div class="form-label">Current Address</div>
                        <div style="color: var(--gray-600);">${escapeHtml(tenant.address || 'Not provided')}</div>
                    </div>
                    <div>
                        <div class="form-label">Broker</div>
                        <div><span class="broker-badge">${escapeHtml(tenant.broker)}</span></div>
                    </div>
                    <div>
                        <div class="form-label">Square Footage</div>
                        <div class="sqft">${escapeHtml(tenant.sqft)} SF</div>
                    </div>
                    <div>
                        <div class="form-label">Geographic Search Area</div>
                        <div>${tenant.area.split(',').map(a =>
                            `<span class="area-tag">${escapeHtml(a.trim())}</span>`
                        ).join(' ')}</div>
                    </div>
                    <div>
                        <div class="form-label">Current Notes</div>
                        <div style="color: var(--gray-600); line-height: 1.5;">${escapeHtml(tenant.notes || 'No notes')}</div>
                    </div>
                    ${noteHistoryHtml}
                    <div style="border-top: 1px solid var(--gray-200); padding-top: 1rem; margin-top: 0.5rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 0.8125rem; color: var(--gray-500);">
                            <div>
                                <strong>Created:</strong> ${formatDate(tenant.createdAt)}<br>
                                by ${escapeHtml(tenant.createdBy || 'Unknown')}
                            </div>
                            <div>
                                <strong>Last Updated:</strong> ${formatDate(tenant.updatedAt)}<br>
                                by ${escapeHtml(tenant.updatedBy || 'Unknown')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const editBtn = document.getElementById('editFromViewBtn');
            if (canEditRecord(tenant)) {
                editBtn.style.display = 'inline-flex';
                editBtn.onclick = () => {
                    closeModal('viewModal');
                    editTenant(id);
                };
            } else {
                editBtn.style.display = 'none';
            }

            openModal('viewModal');
        }

        // Edit tenant
        function editTenant(id) {
            const tenant = tenants.find(t => t.id === id);
            if (!tenant) return;

            document.getElementById('modalTitle').textContent = 'Edit Tenant';
            document.getElementById('tenantId').value = tenant.id;
            document.getElementById('tenantName').value = tenant.name;
            document.getElementById('tenantAddress').value = tenant.address || '';
            document.getElementById('brokerName').value = tenant.broker;
            document.getElementById('sqftRange').value = tenant.sqft;
            document.getElementById('tenantNotes').value = tenant.notes || '';

            // Set up area tags
            clearAreaTags();
            tenant.area.split(',').forEach(a => {
                const trimmed = a.trim();
                if (trimmed) addAreaTag(trimmed);
            });

            // Show note history in edit modal
            showNoteHistoryInForm(tenant);

            openModal('tenantModal');
        }

        // Show note history preview in form
        function showNoteHistoryInForm(tenant) {
            const container = document.getElementById('noteHistoryPreview');
            if (!tenant.noteHistory || tenant.noteHistory.length === 0) {
                container.style.display = 'none';
                return;
            }

            const sortedHistory = [...tenant.noteHistory].sort((a, b) =>
                new Date(b.timestamp) - new Date(a.timestamp)
            );

            container.style.display = 'block';
            container.innerHTML = `
                <div class="note-history" style="margin-top: 0.75rem; border-top: none; padding-top: 0;">
                    <div class="note-history-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                        </svg>
                        Previous Notes (${sortedHistory.length} ${sortedHistory.length === 1 ? 'entry' : 'entries'})
                    </div>
                    ${sortedHistory.slice(0, 3).map((entry, idx) => `
                        <div class="note-entry ${idx === 0 ? 'current' : ''}">
                            <div class="note-entry-header">
                                <span class="note-entry-author">${escapeHtml(entry.author)}</span>
                                <span>${formatDateTime(entry.timestamp)}</span>
                            </div>
                            <div class="note-entry-content">${escapeHtml(entry.text.length > 150 ? entry.text.substring(0, 150) + '...' : entry.text)}</div>
                        </div>
                    `).join('')}
                    ${sortedHistory.length > 3 ? `<p style="font-size: 0.75rem; color: var(--gray-500); margin-top: 0.5rem;">+ ${sortedHistory.length - 3} more entries (view in detail view)</p>` : ''}
                </div>
            `;
        }

        function hideNoteHistory() {
            document.getElementById('noteHistoryPreview').style.display = 'none';
        }

        // Delete tenant
        async function deleteTenant(id) {
            const tenant = tenants.find(t => t.id === id);
            if (!tenant) return;

            if (!confirm(`Are you sure you want to delete "${tenant.name}"?`)) return;

            if (DEMO_MODE) {
                tenants = tenants.filter(t => t.id !== id);
            } else {
                await db.ref(`tenants/${id}`).remove();
            }

            logActivity('delete', tenant.name);
            showToast('Tenant deleted', 'success');
            renderTable();
            updateStats();
            updateFilters();
        }

        // Share modal
        document.getElementById('shareBtn').addEventListener('click', () => {
            document.getElementById('shareLink').value = '';
            openModal('shareModal');
        });

        // Permission option selection
        document.querySelectorAll('.permission-option').forEach(option => {
            option.addEventListener('click', () => {
                const select = option.closest('.permission-select');
                select.querySelectorAll('.permission-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                option.querySelector('input').checked = true;
            });
        });

        // Generate share link
        document.getElementById('generateLinkBtn').addEventListener('click', async () => {
            const permission = document.querySelector('input[name="permission"]:checked').value;
            const selectedRecords = Array.from(document.getElementById('recordAccess').selectedOptions).map(o => o.value);

            const inviteId = generateId();
            const invite = {
                id: inviteId,
                permission,
                records: selectedRecords.length > 0 ? selectedRecords : null,
                createdBy: currentUser.name,
                createdAt: new Date().toISOString()
            };

            if (!DEMO_MODE) {
                await db.ref(`invites/${inviteId}`).set(invite);
            }

            const baseUrl = window.location.origin + window.location.pathname;
            const link = `${baseUrl}?invite=${inviteId}`;
            document.getElementById('shareLink').value = link;

            showToast('Share link generated!', 'success');
        });

        // Copy link
        document.getElementById('copyLinkBtn').addEventListener('click', () => {
            const link = document.getElementById('shareLink');
            link.select();
            document.execCommand('copy');
            showToast('Link copied to clipboard!', 'success');
        });

        // Share individual record
        function shareRecord(id) {
            document.getElementById('shareRecordId').value = id;
            document.getElementById('recordShareLink').value = '';
            openModal('recordShareModal');
        }

        document.getElementById('generateRecordLinkBtn').addEventListener('click', async () => {
            const recordId = document.getElementById('shareRecordId').value;
            const permission = document.querySelector('input[name="recordPermission"]:checked').value;

            const inviteId = generateId();
            const invite = {
                id: inviteId,
                permission,
                records: [recordId],
                createdBy: currentUser.name,
                createdAt: new Date().toISOString()
            };

            if (!DEMO_MODE) {
                await db.ref(`invites/${inviteId}`).set(invite);
            }

            const baseUrl = window.location.origin + window.location.pathname;
            const link = `${baseUrl}?invite=${inviteId}&record=${recordId}`;
            document.getElementById('recordShareLink').value = link;

            showToast('Record share link generated!', 'success');
        });

        document.getElementById('copyRecordLinkBtn').addEventListener('click', () => {
            const link = document.getElementById('recordShareLink');
            link.select();
            document.execCommand('copy');
            showToast('Link copied to clipboard!', 'success');
        });

        // Activity log
        document.getElementById('activityBtn').addEventListener('click', () => {
            renderActivities();
            openModal('activityModal');
        });

        function renderActivities() {
            const list = document.getElementById('activityList');

            if (activities.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 2rem;">No activity yet</p>';
                return;
            }

            list.innerHTML = activities.map(activity => {
                const iconClass = activity.type === 'add' ? 'add' : activity.type === 'edit' ? 'edit' : 'delete';
                const iconSvg = activity.type === 'add'
                    ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>'
                    : activity.type === 'edit'
                    ? '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>'
                    : '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>';

                const actionText = activity.type === 'add' ? 'added' : activity.type === 'edit' ? 'updated' : 'deleted';

                return `
                    <div class="activity-item">
                        <div class="activity-icon ${iconClass}">${iconSvg}</div>
                        <div class="activity-content">
                            <div class="activity-text">
                                <strong>${escapeHtml(activity.user)}</strong> ${actionText}
                                <strong>${escapeHtml(activity.tenant)}</strong>
                                ${activity.changes ? `<br><span style="color: var(--gray-500)">${escapeHtml(activity.changes)}</span>` : ''}
                            </div>
                            <div class="activity-time">${formatDateTime(activity.timestamp)}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function logActivity(type, tenant, changes = null) {
            const activity = {
                id: generateId(),
                type,
                tenant,
                user: currentUser.name,
                changes,
                timestamp: new Date().toISOString()
            };

            if (DEMO_MODE) {
                activities.unshift(activity);
            } else {
                await db.ref(`activities/${activity.id}`).set(activity);
            }
        }

        // Export to Excel
        document.getElementById('exportBtn').addEventListener('click', () => {
            let visibleTenants = tenants;
            if (currentUser.accessRecords && currentUser.accessRecords.length > 0) {
                visibleTenants = tenants.filter(t => currentUser.accessRecords.includes(t.id));
            }

            // Create CSV content
            const headers = ['Tenant Name', 'Address', 'Broker', 'Search Area', 'Square Footage', 'Notes', 'Last Updated', 'Updated By'];
            const rows = visibleTenants.map(t => [
                t.name,
                t.address || '',
                t.broker,
                t.area,
                t.sqft,
                t.notes || '',
                formatDateTime(t.updatedAt),
                t.updatedBy || ''
            ]);

            const csv = [headers, ...rows]
                .map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                .join('\n');

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tenant-tracker-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);

            showToast('Export downloaded!', 'success');
        });

        // Utility functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;');
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric',
                hour: 'numeric', minute: '2-digit'
            });
        }

        function formatNumber(num) {
            return num.toLocaleString();
        }

        function parseSqft(str) {
            if (!str) return 0;
            const numbers = str.replace(/,/g, '').match(/\d+/g);
            return numbers ? parseInt(numbers[0]) : 0;
        }

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    ${type === 'success'
                        ? '<path d="M20 6L9 17l-5-5"/>'
                        : type === 'error'
                        ? '<circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/>'
                        : '<circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/>'}
                </svg>
                ${message}
            `;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Close modals on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // ==========================================
        // AREA AUTOCOMPLETE & TAG INPUT FUNCTIONS
        // ==========================================

        const areaInput = document.getElementById('searchAreaInput');
        const areaAutocomplete = document.getElementById('areaAutocomplete');
        const areaTagContainer = document.getElementById('areaTagContainer');

        // Clear all area tags
        function clearAreaTags() {
            selectedAreaTags = [];
            renderAreaTags();
        }

        // Add an area tag
        function addAreaTag(area) {
            const trimmed = area.trim();
            if (trimmed && !selectedAreaTags.includes(trimmed)) {
                selectedAreaTags.push(trimmed);
                knownAreas.add(trimmed); // Remember for future autocomplete
                renderAreaTags();
            }
            areaInput.value = '';
            hideAutocomplete();
        }

        // Remove an area tag
        function removeAreaTag(area) {
            selectedAreaTags = selectedAreaTags.filter(a => a !== area);
            renderAreaTags();
        }

        // Render area tags
        function renderAreaTags() {
            // Remove existing tags (but keep the input)
            const existingTags = areaTagContainer.querySelectorAll('.tag-input-tag');
            existingTags.forEach(tag => tag.remove());

            // Add tags before the input
            selectedAreaTags.forEach(area => {
                const tag = document.createElement('span');
                tag.className = 'tag-input-tag';
                tag.innerHTML = `
                    ${escapeHtml(area)}
                    <button type="button" onclick="removeAreaTag('${escapeHtml(area).replace(/'/g, "\\'")}')">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                `;
                areaTagContainer.insertBefore(tag, areaInput);
            });

            // Update hidden input
            document.getElementById('searchArea').value = selectedAreaTags.join(', ');
        }

        // Show autocomplete suggestions
        function showAutocomplete(filter = '') {
            const filterLower = filter.toLowerCase();
            const suggestions = [...knownAreas]
                .filter(a => !selectedAreaTags.includes(a))
                .filter(a => filterLower === '' || a.toLowerCase().includes(filterLower))
                .sort((a, b) => {
                    // Prioritize matches that start with the filter
                    const aStarts = a.toLowerCase().startsWith(filterLower);
                    const bStarts = b.toLowerCase().startsWith(filterLower);
                    if (aStarts && !bStarts) return -1;
                    if (!aStarts && bStarts) return 1;
                    return a.localeCompare(b);
                })
                .slice(0, 8);

            if (suggestions.length === 0 && filter === '') {
                areaAutocomplete.innerHTML = '<div class="autocomplete-hint">Type a new geographic area to add it</div>';
            } else if (suggestions.length === 0) {
                areaAutocomplete.innerHTML = `
                    <div class="autocomplete-hint">Press Enter to add "${escapeHtml(filter)}" as a new area</div>
                `;
            } else {
                areaAutocomplete.innerHTML = `
                    <div class="autocomplete-hint">Select from previously used areas or press Enter to add new</div>
                    ${suggestions.map((s, idx) => `
                        <div class="autocomplete-item ${idx === highlightedAutocompleteIndex ? 'highlighted' : ''}"
                             data-area="${escapeHtml(s)}"
                             onclick="addAreaTag('${escapeHtml(s).replace(/'/g, "\\'")}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/>
                                <circle cx="12" cy="10" r="3"/>
                            </svg>
                            ${escapeHtml(s)}
                        </div>
                    `).join('')}
                `;
            }

            areaAutocomplete.classList.add('active');
            highlightedAutocompleteIndex = -1;
        }

        // Hide autocomplete
        function hideAutocomplete() {
            areaAutocomplete.classList.remove('active');
            highlightedAutocompleteIndex = -1;
        }

        // Area input event handlers
        areaInput.addEventListener('focus', () => {
            showAutocomplete(areaInput.value);
        });

        areaInput.addEventListener('input', () => {
            showAutocomplete(areaInput.value);
        });

        areaInput.addEventListener('keydown', (e) => {
            const items = areaAutocomplete.querySelectorAll('.autocomplete-item');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                highlightedAutocompleteIndex = Math.min(highlightedAutocompleteIndex + 1, items.length - 1);
                updateHighlight(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                highlightedAutocompleteIndex = Math.max(highlightedAutocompleteIndex - 1, -1);
                updateHighlight(items);
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (highlightedAutocompleteIndex >= 0 && items[highlightedAutocompleteIndex]) {
                    addAreaTag(items[highlightedAutocompleteIndex].dataset.area);
                } else if (areaInput.value.trim()) {
                    addAreaTag(areaInput.value.trim());
                }
            } else if (e.key === ',' || e.key === 'Tab') {
                if (areaInput.value.trim()) {
                    e.preventDefault();
                    addAreaTag(areaInput.value.trim());
                }
            } else if (e.key === 'Backspace' && areaInput.value === '' && selectedAreaTags.length > 0) {
                removeAreaTag(selectedAreaTags[selectedAreaTags.length - 1]);
            } else if (e.key === 'Escape') {
                hideAutocomplete();
            }
        });

        function updateHighlight(items) {
            items.forEach((item, idx) => {
                item.classList.toggle('highlighted', idx === highlightedAutocompleteIndex);
            });
        }

        // Click on tag container focuses input
        areaTagContainer.addEventListener('click', (e) => {
            if (e.target === areaTagContainer) {
                areaInput.focus();
            }
        });

        // Hide autocomplete when clicking outside
        document.addEventListener('click', (e) => {
            if (!areaTagContainer.contains(e.target) && !areaAutocomplete.contains(e.target)) {
                hideAutocomplete();
            }
        });

        // ==========================================
        // MAP VIEW FUNCTIONS
        // ==========================================

        let map = null;
        let markersLayer = null;
        let heatLayer = null;
        let currentMapMode = 'markers'; // 'markers', 'heatmap', or 'both'
        let geocodingCache = {}; // Cache geocoded addresses

        // View toggle handlers
        document.getElementById('tableViewBtn').addEventListener('click', () => {
            document.getElementById('tableViewBtn').classList.add('active');
            document.getElementById('mapViewBtn').classList.remove('active');
            document.querySelector('.table-container').style.display = 'block';
            document.getElementById('mapContainer').classList.remove('active');
        });

        document.getElementById('mapViewBtn').addEventListener('click', () => {
            document.getElementById('mapViewBtn').classList.add('active');
            document.getElementById('tableViewBtn').classList.remove('active');
            document.querySelector('.table-container').style.display = 'none';
            document.getElementById('mapContainer').classList.add('active');
            initMap();
        });

        // Map toggle buttons
        document.getElementById('toggleMarkers').addEventListener('click', () => {
            setMapMode('markers');
        });

        document.getElementById('toggleHeatmap').addEventListener('click', () => {
            setMapMode('heatmap');
        });

        document.getElementById('toggleBoth').addEventListener('click', () => {
            setMapMode('both');
        });

        function setMapMode(mode) {
            currentMapMode = mode;
            document.querySelectorAll('.map-toggle button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(mode === 'markers' ? 'toggleMarkers' : mode === 'heatmap' ? 'toggleHeatmap' : 'toggleBoth').classList.add('active');
            updateMapLayers();
        }

        function updateMapLayers() {
            if (!map) return;

            if (markersLayer) {
                if (currentMapMode === 'markers' || currentMapMode === 'both') {
                    markersLayer.addTo(map);
                } else {
                    map.removeLayer(markersLayer);
                }
            }

            if (heatLayer) {
                if (currentMapMode === 'heatmap' || currentMapMode === 'both') {
                    heatLayer.addTo(map);
                } else {
                    map.removeLayer(heatLayer);
                }
            }
        }

        // Initialize map
        function initMap() {
            if (map) {
                map.invalidateSize();
                refreshMapData();
                return;
            }

            // Default center (US)
            map = L.map('map').setView([39.8283, -98.5795], 4);

            // Add tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Initialize layers
            markersLayer = L.layerGroup().addTo(map);

            refreshMapData();
        }

        // Refresh map data
        async function refreshMapData() {
            if (!map) return;

            const statusEl = document.getElementById('geocodeStatus');
            statusEl.className = 'geocode-status loading';
            statusEl.textContent = 'Geocoding addresses...';

            // Clear existing layers
            markersLayer.clearLayers();
            if (heatLayer) {
                map.removeLayer(heatLayer);
            }

            // Filter tenants that have addresses
            const tenantsWithAddresses = tenants.filter(t => t.address && t.address.trim());

            if (tenantsWithAddresses.length === 0) {
                statusEl.className = 'geocode-status';
                statusEl.textContent = 'No tenant addresses to display. Add addresses to see locations on the map.';
                return;
            }

            const heatData = [];
            let geocodedCount = 0;
            let errorCount = 0;
            const bounds = [];

            for (const tenant of tenantsWithAddresses) {
                try {
                    const coords = await geocodeAddress(tenant.address);
                    if (coords) {
                        geocodedCount++;
                        bounds.push([coords.lat, coords.lng]);

                        // Add marker
                        const marker = L.circleMarker([coords.lat, coords.lng], {
                            radius: 8,
                            fillColor: '#3b82f6',
                            color: '#fff',
                            weight: 2,
                            opacity: 1,
                            fillOpacity: 0.8
                        });

                        marker.bindPopup(`
                            <div class="popup-title">${escapeHtml(tenant.name)}</div>
                            <div class="popup-detail">${escapeHtml(tenant.address)}</div>
                            <div class="popup-detail">Broker: ${escapeHtml(tenant.broker)}</div>
                            <div class="popup-detail popup-sqft">${escapeHtml(tenant.sqft)} SF</div>
                        `);

                        markersLayer.addLayer(marker);

                        // Add to heat data with intensity based on sqft
                        const sqftValue = tenant.sqftMin || parseSqft(tenant.sqft);
                        const intensity = Math.min(sqftValue / 10000, 10); // Normalize intensity
                        heatData.push([coords.lat, coords.lng, intensity]);

                        // Save coordinates to Firebase for future use
                        if (!DEMO_MODE && (!tenant.lat || !tenant.lng)) {
                            db.ref(`tenants/${tenant.id}`).update({
                                lat: coords.lat,
                                lng: coords.lng
                            });
                        }
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                    console.error(`Failed to geocode ${tenant.address}:`, error);
                }

                // Update status
                statusEl.textContent = `Geocoding addresses... ${geocodedCount + errorCount}/${tenantsWithAddresses.length}`;
            }

            // Create heat layer
            if (heatData.length > 0) {
                heatLayer = L.heatLayer(heatData, {
                    radius: 35,
                    blur: 25,
                    maxZoom: 10,
                    max: 10,
                    gradient: {
                        0.2: 'blue',
                        0.4: 'lime',
                        0.6: 'yellow',
                        0.8: 'orange',
                        1.0: 'red'
                    }
                });

                if (currentMapMode === 'heatmap' || currentMapMode === 'both') {
                    heatLayer.addTo(map);
                }
            }

            // Fit map to bounds
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }

            // Update status
            statusEl.className = 'geocode-status';
            if (errorCount > 0) {
                statusEl.textContent = `Showing ${geocodedCount} locations. ${errorCount} address(es) could not be found.`;
            } else {
                statusEl.textContent = `Showing ${geocodedCount} tenant locations.`;
            }

            updateMapLayers();
        }

        // Geocode address using OpenStreetMap Nominatim
        async function geocodeAddress(address) {
            // Check if tenant already has coordinates
            const tenant = tenants.find(t => t.address === address);
            if (tenant && tenant.lat && tenant.lng) {
                return { lat: tenant.lat, lng: tenant.lng };
            }

            // Check cache
            if (geocodingCache[address]) {
                return geocodingCache[address];
            }

            // Rate limit: wait 1 second between requests (Nominatim policy)
            await new Promise(resolve => setTimeout(resolve, 1000));

            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`,
                    {
                        headers: {
                            'User-Agent': 'TenantTracker/1.0'
                        }
                    }
                );

                const data = await response.json();

                if (data && data.length > 0) {
                    const result = {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                    geocodingCache[address] = result;
                    return result;
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }

            return null;
        }

        // Print map
        document.getElementById('printMapBtn').addEventListener('click', () => {
            window.print();
        });

        // Initialize
        init();
    </script>
</body>
</html>
